# Story 002.003.2: Migration Tools Interface Rebuild

**Epic**: Complete Conjugation System Architectural Rebuild

**As a** system administrator  
**I want** a simplified, working migration tools interface integrated into the admin section  
**So that** I can manage database migrations reliably from the main admin interface

---

## Problem

Current MigrationToolsInterface (5588 lines):
- **Step 2 broken** - metadata doesn't load/disappears  
- **Edit vs create inconsistent** - edit uses cached data
- **50+ useState hooks** - causes race conditions
- **Database schema errors** - wrong table names
- **Unmaintainable** - patches fail due to complexity

SimpleMigrationTest **proves clean architecture works**.

---

## Admin Integration Requirements

### Location & Navigation:
- **Admin Directory**: `/app/admin/migration-tools/page.tsx`
- **Top Navigation**: Add "Migration Tools" to admin dropdown menu
- **Admin Layout**: Integrate with existing admin layout and styling
- **Access Control**: Restrict to admin users only
- **Breadcrumbs**: Show current location in admin section

### Cleanup Requirements:
- **Remove old component**: Delete existing `MigrationToolsInterface.tsx` (5588 lines)
- **Remove test components**: Delete `SimpleMigrationTest.tsx` and `/admin/simple-migration-test/` 
- **Remove redundant pages**: Delete `/admin/migration-tools-refactored/` test page
- **Clean up imports**: Remove unused imports from components that referenced old system
- **Update navigation**: Replace old migration tool links with new admin integration

---

## Complete Feature Requirements

### 📊 AUDIT TAB - Database Analysis
- **Tag Analysis Engine**: Scan all tables for inconsistencies, missing data, malformed tags
- **Database Statistics**: Live counts of dictionary, word_forms, word_translations, form_translations
- **Migration Issue Detection**: Critical/high/medium/low priority issues with auto-fix suggestions
- **Debug Logging System**: Real-time operation logs with expand/collapse, clear functionality  
- **SQL Preview**: Show generated SQL queries before execution
- **Schema Validation**: Check table structures and column types
- **Data Integrity Checks**: Orphaned records, missing relationships, constraint violations

### 🔧 MIGRATION TAB - Rule Creation & Execution
#### Rule Builder System:
- **Multi-Step Wizard**: Config → Mappings → Words → Forms → Translations → Tags
- **Table Targeting**: dictionary, word_forms, word_translations, form_translations, "all_tables"
- **Column Targeting**: tags, context_metadata, italian, translation, form_text, custom columns
- **Operation Types**: replace, add, remove with bulk operation support
- **Prevent Duplicates**: Toggle for duplicate handling during operations

#### Word Search & Selection:
- **Advanced Word Search**: Real-time search with fuzzy matching and filters
- **Word Tag Analysis**: Deep-dive analysis of individual words across all tables
- **Multi-Word Selection**: Batch selection with selection state management
- **Word-Specific Drill-Down**: View all tags/metadata for specific words

#### Form & Translation Targeting:
- **Form Selection Modes**: all-forms, specific-forms with individual form picking
- **Translation Selection Modes**: all-translations, specific-translations with individual selection
- **Form/Translation Preview**: Show selected items with their current metadata
- **Selection Validation**: Ensure selected items exist and are accessible

#### **Step 2 Metadata Loading** (CRITICAL FIX):
- **Dynamic Tag/Metadata Extraction**: Load available tags from selected forms/translations
- **Multi-Table Support**: Handle dictionary.tags[], word_forms.tags[], word_translations.context_metadata
- **Real-Time Updates**: Update available options as user changes selections
- **Edit Mode Consistency**: Re-query database in edit mode (don't use cached data)
- **Tag/Metadata Filtering**: Search and filter available options
- **Visual Indicators**: Show tag sources (forms vs translations) with different styling

#### Mapping Builder:
- **From→To Mappings**: Create transformation rules with validation
- **Bulk Mapping Creation**: Generate multiple mappings from patterns
- **Mapping Validation**: Check for conflicts and invalid transformations
- **Mapping Templates**: Pre-built patterns for common transformations
- **Mapping Preview**: Show exactly what will change

#### Rule Management:
- **Default Rules Library**: Pre-built rules for terminology, metadata, cleanup operations
- **Custom Rule Creation**: Build rules from scratch with full customization
- **Rule Save/Load System**: Named rule persistence with descriptions
- **Rule Templates**: Reusable rule patterns for common operations
- **Rule Archiving**: Archive old rules while preserving history
- **Rule Validation**: Check rule completeness and correctness

#### Preview & Execution:
- **Comprehensive Preview**: Show exactly what records will change and how
- **Affected Record Count**: Accurate count of records that will be modified
- **SQL Generation**: Generate and display actual SQL that will execute
- **Dry Run Mode**: Test execution without making changes
- **Batch Processing**: Process large datasets in manageable chunks
- **Progress Tracking**: Real-time progress bars and status updates
- **Atomic Transactions**: Ensure all-or-nothing execution with rollback
- **Error Handling**: Graceful failure handling with detailed error messages

### 📈 PROGRESS TAB - Execution Management
- **Complete Execution History**: Chronological log of all migration executions
- **Advanced Search & Filtering**: Filter by date range, status, table, description, user
- **Detailed Execution Results**: Expandable details showing exactly what changed
- **Performance Metrics**: Execution time, affected record counts, success rates
- **Revert Operations**: One-click rollback of specific executions with safety checks
- **Execution Comparison**: Compare before/after states of data
- **Export Capabilities**: Export execution logs and results
- **Execution Analytics**: Trends, patterns, and optimization suggestions

### 🔄 Advanced Features
#### Data Management:
- **Multi-Table Operations**: Execute rules across multiple tables simultaneously
- **Schema Detection**: Automatically detect and adapt to table structure changes
- **Data Backup**: Automatic backups before major operations
- **Incremental Updates**: Apply changes incrementally with checkpoint saving
- **Conflict Resolution**: Handle data conflicts during complex operations

#### User Experience:
- **Admin Theme Integration**: Match existing admin interface styling and layout
- **Responsive Design**: Mobile-friendly interface for remote administration
- **Keyboard Shortcuts**: Power-user shortcuts for common operations
- **Contextual Help**: In-line help and tooltips for complex features
- **User Preferences**: Customizable interface and default settings
- **Recent Actions**: Quick access to recently used rules and operations

---

## Technical Architecture (Simplified)

### File Structure:
```
app/admin/migration-tools/
├── page.tsx                   (~100 lines) ← Main admin page
├── components/
│   ├── MigrationToolsInterface.tsx (~200 lines) ← Main component
│   ├── tabs/
│   │   ├── AuditTab.tsx           (~400 lines)
│   │   ├── MigrationTab.tsx       (~500 lines)  
│   │   └── ProgressTab.tsx        (~300 lines)
│   ├── shared/
│   │   ├── WordSearch.tsx         (~200 lines)
│   │   ├── Step2Metadata.tsx      (~150 lines) ← THE CRITICAL FIX
│   │   ├── RuleBuilder.tsx        (~250 lines)
│   │   ├── PreviewEngine.tsx      (~150 lines)
│   │   └── ExecutionEngine.tsx    (~200 lines)
│   └── services/
│       ├── DatabaseService.ts     (~300 lines)
│       ├── RuleService.ts         (~200 lines)
│       └── HistoryService.ts      (~100 lines)

Total: ~2650 lines (down from 5588)
```

### Admin Navigation Integration:
```typescript
// components/admin/AdminNavigation.tsx (update existing)
const adminMenuItems = [
  { href: "/admin/dashboard", label: "Dashboard" },
  { href: "/admin/users", label: "Users" },
  { href: "/admin/content", label: "Content" },
  { href: "/admin/migration-tools", label: "Migration Tools" }, // ← ADD THIS
  { href: "/admin/settings", label: "Settings" }
];
```

### Cleanup Checklist:
```
Files to DELETE:
├── components/admin/MigrationToolsInterface.tsx (5588 lines)
├── components/admin/SimpleMigrationTest.tsx
├── app/admin/simple-migration-test/page.tsx
├── app/admin/migration-tools-refactored/page.tsx
└── components/admin/migration-tools/ (old directory)

Imports to UPDATE:
├── Any components importing old MigrationToolsInterface
├── Navigation components with old migration tool links
└── Any references to deleted test pages
```

---

## Acceptance Criteria

### Admin Integration:
- [ ] **Admin location**: Located at `/app/admin/migration-tools/page.tsx`
- [ ] **Navigation integration**: "Migration Tools" appears in admin dropdown menu
- [ ] **Admin layout**: Uses consistent admin styling and layout patterns
- [ ] **Access control**: Only accessible to users with admin permissions
- [ ] **Breadcrumb navigation**: Shows current location within admin section

### Code Cleanup:
- [ ] **Old component removed**: `MigrationToolsInterface.tsx` (5588 lines) deleted
- [ ] **Test components removed**: All SimpleMigrationTest and test pages deleted
- [ ] **Redundant pages removed**: All `/admin/migration-tools-refactored/` content deleted
- [ ] **Import cleanup**: No broken imports or references to deleted components
- [ ] **Navigation updated**: Old migration tool links replaced with new admin integration

### Feature Parity:
- [ ] **All 3 tabs** with complete functionality (Audit, Migration, Progress)
- [ ] **Complete rule builder** with all operation types and targeting options
- [ ] **Word search system** with advanced filtering and selection
- [ ] **Step 2 metadata loading** works reliably for all table/column combinations
- [ ] **Rule save/load system** with templates and custom rules
- [ ] **Preview system** showing accurate change predictions
- [ ] **Execution engine** with progress tracking and error handling
- [ ] **Complete execution history** with search, filtering, and revert capabilities
- [ ] **Multi-table operations** with schema detection
- [ ] **Performance monitoring** and optimization features

### Quality Improvements:
- [ ] **Create/edit consistency** - both modes re-query database for current state
- [ ] **Clean codebase** - under 2700 lines total (vs 5588)
- [ ] **Proper database integration** - correct table/column names throughout
- [ ] **No race conditions** - simplified, reliable state management
- [ ] **Fast performance** - optimized queries and efficient operations
- [ ] **Admin theme integration** - consistent with existing admin interface
- [ ] **Mobile responsiveness** - works on tablets and mobile devices

---

## Implementation Plan

### Phase 1: Admin Integration & Cleanup (Week 1)
- Create new admin page structure at `/app/admin/migration-tools/`
- Update admin navigation to include Migration Tools
- **Delete old components** and clean up imports
- Set up admin layout and access control
- **Step 2 metadata loading fix** (critical)

### Phase 2: Core Features (Week 2)  
- Complete rule builder with all targeting options
- Word search with advanced filtering
- Preview system with accurate change prediction
- Basic execution engine with admin theme integration

### Phase 3: Advanced Features (Week 3)
- Rule save/load system with templates
- Complete execution history and revert
- Multi-table operations
- Performance optimization

### Phase 4: Testing & Polish (Week 4)
- Admin integration testing
- Error handling and edge cases
- User experience improvements
- Final cleanup verification

---

## Success Metrics

- **Admin integration** complete with proper navigation and access control
- **Codebase cleanup** removes 5588+ lines of redundant code
- **Step 2 functionality** works 100% reliably (no disappearing metadata)
- **All existing features** preserved with improved reliability
- **Total code reduction** of 50%+ while maintaining full functionality
- **User task completion time** improved by 50%
- **System reliability** increased to 99%+ success rate

**Complete feature parity with proper admin integration and dramatic code simplification.**