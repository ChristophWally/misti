# Story 002.003.1: Tag Schema Restructure Migration

**Epic**: Complete Conjugation System Architectural Rebuild

**As a** developer and system architect  
**I want** to restructure the tag schema across all core tables to separate mandatory metadata from optional descriptive tags  
**So that** the system has consistent, structured metadata for generation/interface logic while maintaining flexible tagging for descriptive purposes

---

## Background & Problem Statement

The current tag system has **critical inconsistencies across core tables** that create migration tool complexity and maintenance issues:

### Current State Problems:
- **`dictionary.tags`**: `string[]` with ~200 mixed mandatory + optional tags
- **`word_forms.tags`**: `string[]` with ~300 mixed mandatory + optional tags  
- **`word_translations.context_metadata`**: `jsonb` (already structured - good!)
- **`form_translations`**: No structured metadata system

### Impact on System:
- Migration tools must handle 3 different data formats
- Generation logic scattered across array searches vs object property access
- No clear distinction between "affects functionality" vs "descriptive only" tags
- Complex Step 2 metadata loading due to format inconsistencies
- Difficult to maintain data quality and validation

---

## Solution: Unified Metadata Architecture

### Target Schema (All 4 Core Tables):
```sql
-- Every core table gets BOTH:
metadata jsonb,           -- Mandatory fields affecting functionality  
optional_tags text[]      -- Descriptive tags only
```

### Mandatory Metadata Categories (jsonb):

**Dictionary Table** - Core word properties:
```json
{
  "gender": "masculine|feminine|common-gender",
  "conjugation_type": "are|ere|ire|ire-isc", 
  "auxiliary": "avere|essere|both",
  "transitivity": "transitive|intransitive|both",
  "reflexive": true/false,
  "irregular": true/false,
  "word_form_pattern": "form-4|form-2|irregular",
  "gradable": true/false,
  "frequency_tier": "top100|top500|top1000|top5000",
  "cefr_level": "A1|A2|B1|B2|C1|C2"
}
```

**Word Forms Table** - Grammatical properties:
```json
{
  "mood": "indicativo|congiuntivo|condizionale|imperativo",
  "tense": "presente|imperfetto|passato-prossimo|futuro-semplice|...",
  "person": "prima-persona|seconda-persona|terza-persona",
  "number": "singolare|plurale", 
  "gender": "masculine|feminine",
  "irregular": true/false,
  "compound": true/false,
  "reflexive": true/false,
  "morphological_type": "regular|irregular|suppletive"
}
```

**Word Translations Table** - Already good structure, minor enhancements:
```json
{
  "usage": "primary|secondary|specialized",
  "register": "formal|informal|neutral",
  "context": "general|technical|literary",
  "source": "original-dictionary|generated|user-contributed",
  "gender_usage": "male-only|female-only|both|neutral"
}
```

**Form Translations Table** - New structured metadata:
```json
{
  "assignment_method": "automatic|manual|ai-generated",
  "confidence_score": 0.95,
  "context_specificity": "general|specific|idiomatic",
  "usage_frequency": "common|rare|archaic"
}
```

**Optional Tags** - Descriptive only (examples):
```sql
-- All tables can have descriptive tags like:
["freq-top100", "CEFR-A1", "business", "topic-daily-life", "regional-tuscany", "archaic", "poetic", "beginner-friendly"]
```

---

## Acceptance Criteria

### Schema Migration
- [ ] **Database migration scripts** created for all 4 core tables
- [ ] **Backwards compatibility** maintained during transition period
- [ ] **Data preservation** - zero data loss during migration
- [ ] **Rollback capability** - complete reversion possible if needed

### Data Structure Conversion
- [ ] **Mapping service** created to convert current array tags to new structure
- [ ] **Tag classification** completed - mandatory vs optional tags identified
- [ ] **Data validation** ensures all converted data meets new schema constraints
- [ ] **Edge case handling** for malformed or missing tag data

### System Integration  
- [ ] **Migration tools** updated to work with new jsonb + array structure
- [ ] **Generation logic** updated to use structured metadata fields
- [ ] **UI components** display structured metadata appropriately
- [ ] **Search functionality** works with both jsonb metadata and array tags

### Quality Assurance
- [ ] **Migration verification** - sample data manually verified for accuracy
- [ ] **Performance testing** - no degradation in query performance
- [ ] **Consistency validation** - all tables follow identical patterns
- [ ] **Documentation updated** - new schema documented in tag rules file

---

## Technical Implementation Plan

### Phase 1: Schema Analysis & Design (1-2 days)
1. **Analyze existing tags** across all tables to categorize mandatory vs optional
2. **Design jsonb schema** with proper validation constraints  
3. **Create migration mapping** from current tags to new structure
4. **Write validation rules** to ensure data quality

### Phase 2: Migration Scripts (2-3 days)  
1. **Create backup procedures** for all affected tables
2. **Write conversion logic** to transform array tags to jsonb + array
3. **Implement rollback scripts** for safe reversion capability
4. **Test migration on staging** environment with full dataset

### Phase 3: System Updates (3-4 days)
1. **Update migration tools** to handle new schema structure
2. **Modify generation logic** to use structured metadata
3. **Update UI components** for consistent metadata display
4. **Refactor search functionality** for both data types

### Phase 4: Validation & Deployment (1-2 days)
1. **Run comprehensive tests** on converted data  
2. **Performance benchmarking** to ensure no degradation
3. **Manual spot-checking** of critical vocabulary conversions
4. **Deploy with monitoring** and rollback readiness

---

## Migration Strategy

### Current Tag Categorization:
**Mandatory (→ jsonb metadata):**
- Gender, conjugation type, auxiliary selection
- Mood, tense, person, number properties
- Irregularity flags, morphological patterns
- Core usage and register information

**Optional (→ array tags):**
- Frequency rankings (`freq-top100`, `freq-top500`)
- CEFR levels (`CEFR-A1`, `CEFR-A2`)  
- Topic categories (`topic-daily-life`, `business`)
- Regional markers (`regional-tuscany`)
- Style markers (`archaic`, `poetic`, `colloquial`)

### Backwards Compatibility:
- **Keep existing columns** during transition period
- **Populate both formats** until full system migration
- **Feature flags** to enable new schema gradually
- **Monitoring** to catch any integration issues

---

## Definition of Done

- [ ] All 4 core tables have consistent `metadata jsonb` + `optional_tags text[]` columns
- [ ] Existing data successfully migrated with 100% preservation
- [ ] Migration tools work seamlessly with new schema structure  
- [ ] Step 2 metadata loading works consistently across all table types
- [ ] Performance benchmarks show no degradation from schema change
- [ ] Full rollback capability tested and verified
- [ ] Documentation updated to reflect new architecture
- [ ] Code review completed and approved by senior developer

**Success Metrics:**
- Zero data loss during migration
- Migration tool Step 2 functionality works 100% reliably
- Query performance maintained or improved
- Developer experience simplified through consistent schema
- System maintainability significantly improved

---

## Risk Mitigation

**Data Loss Risk**: Comprehensive backup and validation procedures  
**Performance Risk**: Benchmark testing and index optimization  
**Integration Risk**: Gradual rollout with feature flags and monitoring  
**Complexity Risk**: Clear documentation and training for development team

**Dependencies**: Must coordinate with Story 002.003.2 (Migration Tool Rebuild) for optimal integration.